# 中山大学数据科学与计算机学院本科生实验报告
## （2018年秋季学期）
| 课程名称 | 手机平台应用开发 | 任课老师 | 郑贵锋 |
| :------------: | :-------------: | :------------: | :-------------: |
| 年级 | 2016级 | 专业（方向） | 数字媒体技术 |
| 学号 | 16340219 | 姓名 | 王亮岛 |
| 电话 | 15920804195 | Email | 1484243022@qq.com |
| 开始日期 | 2018.1.1 | 完成日期 |2018.1.19|

---

## 一、实验题目

## 期末项目

## 2048小游戏

---

## 二、实现内容

## 项目内容要求

- 运用综合知识编写功能比较完善的android项目
- **2019.1.12前完成所有功能开发，额外两周完成项目文档，2019.1.26前提交所有内容**

##实现内容

- 本游戏是仿照2048小游戏的运行模式开发的一个具有模式切换的2048小游戏，
- 在本游戏开始界面会出现游戏模式的选择，玩家可以选择4\*4,5\*5,6\*6的游戏模式，
- 进入游戏模式之后会有操作界面和排行榜，
- 退出游戏会有是否保存当前分数的提示。
- 游戏操作界面设置了音乐播放功能。
- 排行榜中的信息使用的是数据库的保存

##我负责的内容

本人主要负责MainActivity.java，MyDBHelper.java，CreateUserDialog.java以及MyPlayer.java文件的编写。以及项目文档的编写。

---

## 三、课堂实验结果
### (1)实验截图

![](https://gitee.com/group_22/final_project/raw/master/report/Group22/img/2.png)
![](https://gitee.com/group_22/final_project/raw/master/report/Group22/img/3.png)
![](https://gitee.com/group_22/final_project/raw/master/report/Group22/img/4.jpg)

### (2)实验步骤以及关键代码

##### MainActivity.java文件

主要实现排行榜，重新开始游戏，音乐播放控制，游戏提示等功能，并为GameView.java文件提供一系列的接口包括获取当前游戏模式，表格的行和列，游戏分数，游戏时长等功能。

这里最关键的部分的关于排行榜与游戏操作界面的切换，这里我使用了DrawerLayout，toolBar，ActionBarDrawerToggle结合。具体代码如下：

```java
toggle = new ActionBarDrawerToggle(this, drawer, toolbar, R.string.drawer_open, R.string.drawer_close);
toggle.syncState();
```

其中syncState() 方法会自动和toolbar关联, 将开关的图片显示在了action上，如果不设置，也可以有抽屉的效果，不过是默认的图标 。

然后再为DrawerLayout添加监听器，判断DrawerLayout的开关，滑动时的特效。

关于滑动时的特效，这里我参考了网上的博客，

```java
public void onDrawerSlide(View drawerView, float slideOffset) {
    // 滑动的过程当中不断地回调 slideOffset：0~1
    View content = drawer.getChildAt(0);
    float scale = 1 - slideOffset;//1~0
    float leftScale = (float) (1 - 0.7 * scale);
    float rightScale = (float) (0.3f + 0.7 * scale);//0.7~1
    drawerView.setScaleX(leftScale);//1~0.7
    drawerView.setScaleY(leftScale);//1~0.7
    content.setScaleX(rightScale);
    content.setScaleY(rightScale);
    content.setTranslationX(drawerView.getMeasuredWidth() * (1 - scale));//0~width

}
```

这段代码实现了侧滑时的缩放和平移效果，通过不断回调slideOffset设置游戏操作界面的滑动和排行榜的切换之间的宽度。

然后是实现数据库中数据的插入，这里我使用的是SimpleAdapter和listView将数据库中的记录展示出来。

重新开始功能则是使用了一个dialog来再次询问玩家是否要重新开始游戏，当玩家确认时则调用GameView的startGame方法即可。

音乐的播放功能则是判断当前播放状态是播放还是暂停，然后切换到对应的图标，这里我使用的是状态的判断，利用Drawable.ConstantState属性，这样就可以使用equals方法判断状态。

```java
Drawable myDrawable = controlbtn.getDrawable();
                Drawable.ConstantState constantState1 =  getResources().getDrawable(R.mipmap.close).getConstantState();
                Drawable.ConstantState constantState2 =  getResources().getDrawable(R.mipmap.vol).getConstantState();
                if( myDrawable.getConstantState().equals(constantState1)){
                    controlbtn.setImageDrawable(getResources().getDrawable(R.mipmap.vol));
                    if (null != mp){
                        mp.start();
                        mp.setLooping(true);
                    }

                }
                else if(myDrawable.getConstantState().equals(constantState2)){
                    if (null != mp)
                        mp.pause();
                    controlbtn.setImageDrawable(getResources().getDrawable(R.mipmap.close));
                }
```

当玩家选择退出游戏的时候，应用需要将玩家当前的游戏记录与数据库中的游戏记录比较，如果数据库为可以存储状态或者当前记录大于数据库中任何一个记录，则弹出一个dialog询问玩家是否要存储游戏记录。然后直接调用CreateUserDialog类的方法实现即可。

而且在玩家想要退出时会二次询问玩家是否要退出游戏。

```java
if ((System.currentTimeMillis() - exitTime) > 2000) {
                //弹出提示，可以有多种方式
                Toast.makeText(getApplicationContext(), "再按一次退出游戏", Toast.LENGTH_SHORT).show();
                exitTime = System.currentTimeMillis();
            }
```

##### 数据库设计

自定义了MyDBHelper 继承SQLiteOpenHelper ，数据库中包含有排名，用户名，分数和游戏时长。还需要定义一个函数就是判断当前记录能否保存到数据库中。

```java
public Boolean isOverRank(int rank, int score, String lastTime){
        int cnt = 1;
        db = this.getReadableDatabase();
        cursor = db.rawQuery("select * from " + MyDBHelper.TABLE_NAME + " where Rank = " +  rank + " order by Score desc, LastTime", null);
        if (score != 0 && cursor.getCount() < 10) {
            return true;
        }
        else{
            while (cursor.moveToNext()) {
                if(cnt <= 10 && (score > cursor.getInt(2) || (score == cursor.getInt(2) && lastTime.compareTo(cursor.getString(3)) < 0))){
                    return true;
                }
                ++cnt;
                if(cnt > 10){
                    return false;
                }

            }
        }
        return false;
    }
```

##### CreateUserDialog设计

设置一个dialog，为其定义宽度和高度，从MainActivity中获取要保存的记录，保存时要添加用户名，这样就可以将记录保存到数据库中了。

### (3)实验遇到的困难以及解决思路

关于GameView的高度的设置，因为起始布局GameView的height设为0dp，自填充，导致下面有一片空白，整个布局，看起来如此的怪，在网上百度很久也没有找到一个在xml文件设置布局的方法，最后只能采用一种动态设置的方法，给GameView外面添加一个LinearLayout，然后GameView的height设为match_parent，然后动态设置外侧LinearLayout的高。代码如下：

```java
WindowManager wm = (WindowManager) this.getSystemService(Context.WINDOW_SERVICE);
int width = wm.getDefaultDisplay().getWidth();//屏幕宽度
ViewGroup.LayoutParams lp;
lp= linearLayout.getLayoutParams();
lp.width=width;
lp.height=width;
linearLayout.setLayoutParams(lp);
```

关于附加的提示功能，由于是每个方块中使用了图片的原因，只是改变背景颜色无法提示玩家哪些方块可以合并哪些方块不可以合并，因此我采取了暴力的方法，既然没办法显示可以合并的方块的位置，那么就直接帮助玩家移动并且合并方块吧，因此该提示功能会采取从左到右从上到下扫描的方式，如果满足其中一个条件就合并方块并忽略其余条件。但是这样做有一个后果是不会考虑到后续的操作，非常容易忽视玩家的游戏体验。

```java
public void getTip(){
    if(checkLeft()){
        moveLeft();

    }else if(checkRight()){
        moveRight();

    }else if(checkUp()){
        moveUp();

    }else if(checkDown()){
        moveDown();

    }
}
```

---

## 四、个人总结与个人贡献得分

我们小组的安卓期末项目是做一个游戏，就游戏的可玩性而言，本次项目还是比较成功的，实现了基本的2048的游戏功能，同时还添加了额外的提示功能，只是在游戏的视觉观赏性方面还有所欠缺，动画方面基本没有实现。这是比较遗憾的地方，我主要负责的是游戏主界面，对分数和游戏时间进行实时更新，音乐的播放和暂停，提供提示功能和重玩功能，还提供排行榜的查看功能，总的来说没有涉及到游戏操作的逻辑部分，因此相对而言比较轻松，但是在布局的设置和DrawerLayout，toolBar，ActionBarDrawerToggle这三个组件的使用方面还是花费了我一些时间，但总算学到东西吧。

#### 个人得分：93

---

## 五、思想感悟

有了期中项目的经验，这次我们的分工还算比较明确，对于新的组件例如Drawerlayout，toolBar等有了新的认知和使用的经历，结合学到的数据库等知识，做起来还算是比较得心应手。但是仍然有些许遗憾，游戏的完成度并不是很高，一些预想中的功能没有能全部实现，也罢，在实践中获取新的知识，探索安卓开发领域的新的组件和使用也是学习的一部分。总体而言，我对于我们的项目还是满意的，也谢谢队友们的支持和配合。

---

#### 作业要求
* 命名要求：学号_姓名_实验编号，例如12345678_张三_lab1.md
* 实验报告提交格式为md
* 实验内容不允许抄袭，我们要进行代码相似度对比。如发现抄袭，按0分处理